name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build binaries
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build binary
        run: |
          mkdir -p dist
          BIN_NAME="sshq_${{ matrix.goos }}_${{ matrix.goarch }}"
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} CGO_ENABLED=0 \
            go build -o dist/$BIN_NAME .

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/*

  packages:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Download built binaries
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Install FPM
        run: sudo apt-get update && sudo apt-get install -y ruby ruby-dev gcc make && sudo gem install --no-document fpm

      - name: Create .deb and .rpm packages
        run: |
          mkdir -p artifacts

          for bin in dist/*/*; do
            filename=$(basename "$bin")               # sshq_linux_amd64
            arch=$(echo "$filename" | cut -d'_' -f3)  # amd64
            os=$(echo "$filename" | cut -d'_' -f2)    # linux / darwin

            if [ "$os" = "darwin" ]; then
              # No linux packages for macOS binaries
              continue
            fi

            chmod +x "$bin"

            version="${GITHUB_REF_NAME#v}"  # strip the 'v' prefix

            # Create .deb
            fpm -s dir -t deb \
              -n sshq \
              -v "$version" \
              -a "$arch" \
              --description "SSH alias manager and connector" \
              --license "MIT" \
              "$bin=/usr/local/bin/sshq"

            # Create .rpm
            fpm -s dir -t rpm \
              -n sshq \
              -v "$version" \
              -a "$arch" \
              --description "SSH alias manager and connector" \
              --license "MIT" \
              "$bin=/usr/local/bin/sshq"

            mv *.deb artifacts/ || true
            mv *.rpm artifacts/ || true
          done

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: artifacts/*

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, packages]

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: release_assets/**/*

  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: TheBoredEngineers/homebrew-sshq
          path: homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Download macOS binaries
        run: |
          curl -L -o homebrew-tap/sshq_darwin_arm64 \
            https://github.com/TheBoredEngineers/sshq/releases/download/${{ github.ref_name }}/sshq_darwin_arm64
          curl -L -o homebrew-tap/sshq_darwin_amd64 \
            https://github.com/TheBoredEngineers/sshq/releases/download/${{ github.ref_name }}/sshq_darwin_amd64

      - name: Calculate SHA256
        id: sha
        run: |
          echo "sha_arm=$(shasum -a 256 homebrew-tap/sshq_darwin_arm64 | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "sha_amd=$(shasum -a 256 homebrew-tap/sshq_darwin_amd64 | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          cd homebrew-tap
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Replace version
          sed -i "s/version \".*\"/version \"${GITHUB_REF_NAME#v}\"/g" sshq.rb

          # Replace ARM URL & SHA
          sed -i "s|url \".*arm64\"|url \"https://github.com/TheBoredEngineers/sshq/releases/download/${GITHUB_REF_NAME}/sshq_darwin_arm64\"|g" sshq.rb
          sed -i "s|sha256 \".*AUTOMATED.*\"|sha256 \"${{ steps.sha.outputs.sha_arm }}\"|g" sshq.rb

          # Replace Intel URL & SHA
          sed -i "s|url \".*amd64\"|url \"https://github.com/TheBoredEngineers/sshq/releases/download/${GITHUB_REF_NAME}/sshq_darwin_amd64\"|g" sshq.rb
          sed -i "s|sha256 \".*update-manually.*\"|sha256 \"${{ steps.sha.outputs.sha_amd }}\"|g" sshq.rb

          git add sshq.rb
          git commit -m "Update sshq formula for ${{ github.ref_name }}"
          git push origin main

